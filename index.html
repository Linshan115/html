<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Shopping Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2c5aa0 0%, #4a90a4 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .study-phase {
            display: none;
        }

        .study-phase.active {
            display: block;
        }

        .instructions {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .strategy-box {
            background: #e8f4f8;
            border: 2px solid #2c5aa0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .strategy-option {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .strategy-option:hover {
            border-color: #28a745;
            background: #f1f8e9;
        }

        .strategy-option input[type="checkbox"] {
            margin-right: 10px;
        }

        .strategy-option label {
            cursor: pointer;
            margin: 0;
        }

        .strategy-option.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .strategy-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shopping-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .products-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .category-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-btn:hover, .category-btn.active {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .product-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: white;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .product-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2c5aa0;
        }

        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }
        .price-block {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }
        .unit-price {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .size-note {
            color: #495057;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .product-attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .attribute-tag {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .co2-tag {
            background: #f8d7da;
            color: #721c24;
        }

        .co2-1 { background: #d4edda; color: #155724; }
        .co2-2 { background: #fff3cd; color: #856404; }
        .co2-3 { background: #ffeaa7; color: #856404; }
        .co2-4 { background: #fab1a0; color: #721c24; }
        .co2-5 { background: #e17055; color: white; }

        .packaging-tag {
            background: #d1ecf1;
            color: #0c5460;
        }

        .organic-tag {
            background: #d4edda;
            color: #155724;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background: #e9ecef;
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 5px;
        }

        .add-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
            margin-top: 10px;
        }

        .add-btn:hover:not(:disabled) {
            background: #218838;
        }

        .add-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .cart-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .cart-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .cart-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c5aa0;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
        }

        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .checkout-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.3s ease;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #2c5aa0;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3d6f;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        @media (max-width: 768px) {
            .shopping-container {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛒 Grocery Shopping Study</h1>
            <p>Help us understand consumer decision-making in sustainable shopping</p>
        </div>

        <!-- Phase 1: Welcome & Demographics -->
        <div id="phase-welcome" class="study-phase active">
            <div class="instructions">
                <h2>Welcome to Our Shopping Study</h2>
                <p>Thank you for participating! This study examines how people make grocery shopping decisions. You'll be asked to shop for groceries in a realistic online environment.</p>
                
                
                <button class="btn btn-primary" onclick="startStudy()">Continue to Instructions</button>
            </div>
        </div>

        <!-- Phase 2: Strategy Selection -->
        <div id="phase-strategy-selection" class="study-phase">
            <div class="instructions">
                <p>Imagine you are committed to sustainability goals and need to select <strong id="assigned-strategy-count">1</strong> sustainable strategy to achieve this goal during your grocery shopping.</p>
                <p>Choose the strategy that best aligns with your values and shopping preferences:</p>

                <div id="strategy-options" style="margin: 20px 0;">
                    <h3>Available Strategies:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="strategy-option" data-strategy="organic">
                            <input type="checkbox" id="strategy-organic" value="organic" onchange="validateSelection()">
                            <label for="strategy-organic"><strong>Organic Focus</strong><br>
                            <small>Support chemical-free farming and healthier food systems</small></label>
                        </div>
                        
                        <div class="strategy-option" data-strategy="local">
                            <input type="checkbox" id="strategy-local" value="local" onchange="validateSelection()">
                            <label for="strategy-local"><strong>Local Sourcing</strong><br>
                            <small>Reduce carbon footprint by supporting nearby producers</small></label>
                        </div>
                        
                        <div class="strategy-option" data-strategy="minimal-packaging">
                            <input type="checkbox" id="strategy-minimal-packaging" value="minimal-packaging" onchange="validateSelection()">
                            <label for="strategy-minimal-packaging"><strong>Minimal Packaging</strong><br>
                            <small>Minimize waste by choosing items with less packaging</small></label>
                        </div>
                        
                        <div class="strategy-option" data-strategy="plant-based">
                            <input type="checkbox" id="strategy-plant-based" value="plant-based" onchange="validateSelection()">
                            <label for="strategy-plant-based"><strong>Plant-Based Focus</strong><br>
                            <small>Reduce environmental impact by choosing plant-based options</small></label>
                        </div>
                        
                        <div class="strategy-option" data-strategy="seasonal">
                            <input type="checkbox" id="strategy-seasonal" value="seasonal" onchange="validateSelection()">
                            <label for="strategy-seasonal"><strong>Seasonal Eating</strong><br>
                            <small>Support natural growing cycles and reduce energy consumption</small></label>
                        </div>
                        
                        <div class="strategy-option" data-strategy="bulk-buying">
                            <input type="checkbox" id="strategy-bulk-buying" value="bulk-buying" onchange="validateSelection()">
                            <label for="strategy-bulk-buying"><strong>Bulk Buying</strong><br>
                            <small>Reduce packaging waste by purchasing larger quantities</small></label>
                        </div>
                    </div>
                </div>

                <div id="selection-summary" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <h4>Selected Strategies:</h4>
                    <div id="selected-strategies-list"></div>
                </div>

                <button id="continue-to-instructions" class="btn btn-primary" onclick="proceedToInstructions()" disabled>Continue to Instructions</button>
            </div>
        </div>

        <!-- Phase 3: Instructions & Strategy Display -->
        <div id="phase-instructions" class="study-phase">
            <div class="instructions">
                <h2>Shopping Instructions</h2>
                <p><strong>Scenario:</strong> Imagine you are shopping for your weekly groceries. You need to purchase items for your meals. You will browse products and add them to your cart. You can checkout with any number of items.</p>
                
                <div id="strategy-assignment" class="strategy-box">
                    <!-- Strategy will be inserted here by JavaScript -->
                </div>
                
                <div class="alert alert-warning">
                    <strong>Product Information Guide:</strong>
                    <ul>
                        <li><strong>CO₂ Rating:</strong> 1 = Very Low Impact, 5 = Very High Impact</li>
                        <li><strong>Packaging:</strong> None > Paper > Glass > Plastic (environmental preference)</li>
                        <li><strong>Organic:</strong> Certified organic when labeled</li>
                    </ul>
                </div>
                
                <button class="btn btn-primary" onclick="startShopping()">Start Shopping</button>
            </div>
        </div>

        <!-- Phase 3: Shopping Interface -->
        <div id="phase-shopping" class="study-phase">
            <div class="shopping-container">
                <div class="products-section">
                    <h3>🛍️ Available Products</h3>
                    <div class="category-filter">
                        <button class="category-btn active" onclick="filterCategory('all', this)">All Items</button>
                        <button class="category-btn" onclick="filterCategory('proteins', this)">🥩 Proteins</button>
                        <button class="category-btn" onclick="filterCategory('produce', this)">🥕 Produce</button>
                        <button class="category-btn" onclick="filterCategory('dairy', this)">🥛 Dairy</button>
                        <button class="category-btn" onclick="filterCategory('staples', this)">🍞 Staples</button>
                        <button class="category-btn" onclick="filterCategory('frozen', this)">🧊 Frozen</button>
                    </div>
                    <div id="products-grid" class="products-grid">
                        <!-- Products will be generated by JavaScript -->
                    </div>
                </div>
                
                <div class="cart-section">
                    <div class="cart-header">
                        <h3>🛒 Your Cart</h3>
                    </div>
                    
                    <div class="cart-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="cart-total">$0.00</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="cart-items">0</div>
                            <div class="stat-label">Items</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="cart-co2">0</div>
                            <div class="stat-label">Total CO₂ Points</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="budget-remaining">$50.00</div>
                            <div class="stat-label">Budget Left</div>
                        </div>
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Budget Usage ($50)</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="budget-progress"></div>
                        </div>
                    </div>
                    
                    <div class="cart-items" id="cart-items-list">
                        <p style="text-align: center; color: #6c757d; font-style: italic;">Your cart is empty</p>
                    </div>
                    
                    <button class="checkout-btn" id="checkout-btn" onclick="checkout()" disabled>
                        Complete Shopping
                        <div style="font-size: 12px; margin-top: 5px;">Stay within $45-55 budget</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Phase 4: Completion -->
        <div id="phase-complete" class="study-phase">
            <div class="instructions">
                <h2>Shopping Complete! 🎉</h2>
                <div class="alert alert-success">
                    <p><strong>Thank you for completing the shopping task!</strong></p>
                    <div id="final-summary"></div>
                </div>
                
                <h3>Post-Shopping Questions</h3>
                <div style="margin: 15px 0;">
                    <p><strong>How confident are you that your basket meets your assigned strategy? *</strong></p>
                    <div>
                        <input type="radio" name="confidence" value="1" required> Very Unconfident
                        <input type="radio" name="confidence" value="2" required> Somewhat Unconfident
                        <input type="radio" name="confidence" value="3" required> Neutral
                        <input type="radio" name="confidence" value="4" required> Somewhat Confident
                        <input type="radio" name="confidence" value="5" required> Very Confident
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <p><strong>How difficult was it to follow your assigned strategy? *</strong></p>
                    <div>
                        <input type="radio" name="difficulty" value="1" required> Very Easy
                        <input type="radio" name="difficulty" value="2" required> Easy
                        <input type="radio" name="difficulty" value="3" required> Moderate
                        <input type="radio" name="difficulty" value="4" required> Difficult
                        <input type="radio" name="difficulty" value="5" required> Very Difficult
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="nextToDemographics()">Continue</button>
            </div>
        </div>

        <!-- Phase 5: Demographics -->
        <div id="phase-demographics" class="study-phase">
            <div class="instructions">
                <h2>Demographics</h2>
                <p>Please provide some basic information about yourself.</p>
                
                <div style="margin: 20px 0;">
                    <label><strong>Age: *</strong></label><br>
                    <input type="number" id="age" min="18" max="100" required style="margin-top: 5px; padding: 5px; width: 100px;" placeholder="Enter your age">
                </div>
                
                <div style="margin: 20px 0;">
                    <label><strong>Gender: *</strong></label><br>
                    <div style="margin-top: 5px;">
                        <input type="radio" name="gender" value="female" id="gender-female" required>
                        <label for="gender-female">Female</label><br>
                        <input type="radio" name="gender" value="male" id="gender-male" required>
                        <label for="gender-male">Male</label><br>
                        <input type="radio" name="gender" value="prefer-not-to-say" id="gender-prefer-not-to-say" required>
                        <label for="gender-prefer-not-to-say">Prefer not to say</label>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <label><strong>Any additional comments?</strong></label><br>
                    <textarea id="demographics-comments" rows="4" cols="50" placeholder="Optional additional feedback..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="submitStudy()">Submit Study</button>
            </div>
        </div>
    </div>

    <script>
        // Study configuration
        let studyData = {
            participantId: 'P' + Math.random().toString(36).substr(2, 9),
            condition: Math.random() < 0.5 ? 'single' : 'multiple',
            strategyCount: Math.random() < 0.5 ? 1 : 3, // Randomly assign 1 or 3 strategies
            startTime: new Date(),
            demographics: {},
            cart: [],
            shoppingActions: [],
            finalCartDecisions: [], // Will store final cart items with details
            ipAddress: null
        };

        // Function to get IP address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('Could not get IP address:', error);
                return 'Unknown';
            }
        }

        // Get IP address when page loads
        getIPAddress().then(ip => {
            studyData.ipAddress = ip;
        });

        // Product database
        const products = [
            // Proteins
            { id: 1, name: "Grass-Fed Ground Beef", size: "1 lb", price: 8.99, listPrice: 10.99, unitPrice: 8.99, co2: 5, packaging: "Plastic", organic: false, category: "proteins" },
            { id: 41, name: "Organic Grass-Fed Ground Beef", size: "1 lb", price: 10.99, listPrice: 12.99, unitPrice: 10.99, co2: 5, packaging: "Plastic", organic: true, category: "proteins" },
            { id: 2, name: "Organic Chicken Breast", size: "1 lb", price: 7.49, listPrice: 8.49, unitPrice: 7.49, co2: 3, packaging: "Plastic", organic: true, category: "proteins" },
            { id: 42, name: "Chicken Breast", size: "1 lb", price: 5.99, listPrice: 6.49, unitPrice: 5.99, co2: 3, packaging: "Plastic", organic: false, category: "proteins" },
            { id: 3, name: "Wild Salmon Fillet", size: "8 oz", price: 12.99, listPrice: 14.49, unitPrice: 25.98, co2: 2, packaging: "Plastic", organic: false, category: "proteins" },
            { id: 4, name: "Organic Extra-Firm Tofu", size: "14 oz", price: 3.99, listPrice: 4.49, unitPrice: 4.56, co2: 1, packaging: "Plastic", organic: true, category: "proteins" },
            { id: 43, name: "Extra-Firm Tofu", size: "14 oz", price: 2.99, listPrice: 3.49, unitPrice: 3.41, co2: 1, packaging: "Plastic", organic: false, category: "proteins" },
            { id: 5, name: "Black Beans (Dried)", size: "1 lb", price: 2.49, listPrice: 2.99, unitPrice: 2.49, co2: 1, packaging: "Paper", organic: false, category: "proteins" },
            { id: 44, name: "Organic Black Beans (Dried)", size: "1 lb", price: 3.29, listPrice: 3.99, unitPrice: 3.29, co2: 1, packaging: "Paper", organic: true, category: "proteins" },
            { id: 6, name: "Organic Lentils", size: "1 lb", price: 3.29, listPrice: 3.79, unitPrice: 3.29, co2: 1, packaging: "Paper", organic: true, category: "proteins" },
            { id: 7, name: "Eggs", size: "Dozen", price: 2.99, listPrice: 3.49, unitPrice: 2.99, co2: 2, packaging: "Paper", organic: false, category: "proteins" },
            { id: 8, name: "Free-Range Organic Eggs", size: "Dozen", price: 5.49, listPrice: 5.99, unitPrice: 5.49, co2: 2, packaging: "Paper", organic: true, category: "proteins" },
            
            // Produce
            { id: 9, name: "Organic Bananas", size: "2 lb", price: 2.99, listPrice: 3.49, unitPrice: 1.50, co2: 1, packaging: "None", organic: true, category: "produce" },
            { id: 10, name: "Bananas", size: "3 lb", price: 1.99, listPrice: 2.49, unitPrice: 0.66, co2: 1, packaging: "Plastic", organic: false, category: "produce" },
            { id: 11, name: "Organic Spinach", size: "5 oz", price: 4.49, listPrice: 4.99, unitPrice: 14.37, co2: 1, packaging: "Plastic", organic: true, category: "produce" },
            { id: 45, name: "Spinach", size: "5 oz", price: 3.49, listPrice: 3.99, unitPrice: 11.17, co2: 1, packaging: "Plastic", organic: false, category: "produce" },
            { id: 12, name: "Carrots", size: "2 lb", price: 1.79, listPrice: 1.99, unitPrice: 0.90, co2: 1, packaging: "Plastic", organic: false, category: "produce" },
            { id: 46, name: "Organic Carrots", size: "2 lb", price: 2.49, listPrice: 2.99, unitPrice: 1.25, co2: 1, packaging: "Plastic", organic: true, category: "produce" },
            { id: 13, name: "Organic Apples", size: "3 lb", price: 5.99, listPrice: 6.99, unitPrice: 2.00, co2: 1, packaging: "None", organic: true, category: "produce" },
            { id: 47, name: "Apples", size: "3 lb", price: 4.49, listPrice: 4.99, unitPrice: 1.50, co2: 1, packaging: "None", organic: false, category: "produce" },
            { id: 14, name: "Tomatoes", size: "1 lb", price: 2.49, listPrice: 2.99, unitPrice: 2.49, co2: 2, packaging: "Plastic", organic: false, category: "produce" },
            { id: 48, name: "Organic Tomatoes", size: "1 lb", price: 3.49, listPrice: 3.99, unitPrice: 3.49, co2: 2, packaging: "Plastic", organic: true, category: "produce" },
            { id: 15, name: "Organic Bell Peppers", size: "3 pack", price: 4.99, listPrice: 5.49, unitPrice: 1.66, co2: 1, packaging: "Plastic", organic: true, category: "produce" },
            { id: 49, name: "Bell Peppers", size: "3 pack", price: 3.49, listPrice: 3.99, unitPrice: 1.16, co2: 1, packaging: "Plastic", organic: false, category: "produce" },
            { id: 16, name: "Avocados", size: "4 pack", price: 3.99, listPrice: 4.49, unitPrice: 1.00, co2: 2, packaging: "None", organic: false, category: "produce" },
            { id: 50, name: "Organic Avocados", size: "4 pack", price: 5.49, listPrice: 5.99, unitPrice: 1.37, co2: 2, packaging: "None", organic: true, category: "produce" },
            
            // Dairy & Alternatives
            { id: 17, name: "Whole Milk", size: "Half Gallon", price: 2.79, listPrice: 3.29, unitPrice: 2.79, co2: 3, packaging: "Plastic", organic: false, category: "dairy" },
            { id: 18, name: "Organic Whole Milk", size: "Half Gallon", price: 4.29, listPrice: 4.79, unitPrice: 4.29, co2: 3, packaging: "Glass", organic: true, category: "dairy" },
            { id: 19, name: "Oat Milk", size: "32 oz", price: 3.99, listPrice: 4.49, unitPrice: 0.12, co2: 1, packaging: "Paper", organic: false, category: "dairy" },
            { id: 51, name: "Organic Oat Milk", size: "32 oz", price: 4.79, listPrice: 5.29, unitPrice: 0.15, co2: 1, packaging: "Paper", organic: true, category: "dairy" },
            { id: 52, name: "Almond Milk", size: "32 oz", price: 3.79, listPrice: 4.29, unitPrice: 0.12, co2: 2, packaging: "Paper", organic: false, category: "dairy" },
            { id: 20, name: "Organic Almond Milk", size: "32 oz", price: 4.49, listPrice: 4.99, unitPrice: 0.14, co2: 2, packaging: "Paper", organic: true, category: "dairy" },
            { id: 21, name: "Cheddar Cheese", size: "8 oz", price: 3.99, listPrice: 4.49, unitPrice: 7.98, co2: 4, packaging: "Plastic", organic: false, category: "dairy" },
            { id: 23, name: "Yogurt", size: "32 oz", price: 3.49, listPrice: 3.99, unitPrice: 0.11, co2: 2, packaging: "Plastic", organic: false, category: "dairy" },
            
            // Staples & Pantry
            { id: 24, name: "White Bread", size: "20 oz loaf", price: 1.99, listPrice: 2.49, unitPrice: 0.10, co2: 2, packaging: "Plastic", organic: false, category: "staples" },
            { id: 26, name: "Brown Rice", size: "2 lb", price: 3.49, listPrice: 3.99, unitPrice: 1.75, co2: 1, packaging: "Paper", organic: false, category: "staples" },
            { id: 54, name: "Organic Brown Rice", size: "2 lb", price: 4.49, listPrice: 4.99, unitPrice: 2.25, co2: 1, packaging: "Paper", organic: true, category: "staples" },
            { id: 27, name: "Organic Quinoa", size: "1 lb", price: 6.99, listPrice: 7.99, unitPrice: 6.99, co2: 1, packaging: "Paper", organic: true, category: "staples" },
            { id: 55, name: "Quinoa", size: "1 lb", price: 5.49, listPrice: 5.99, unitPrice: 5.49, co2: 1, packaging: "Paper", organic: false, category: "staples" },
            { id: 28, name: "Whole Wheat Pasta", size: "1 lb", price: 1.79, listPrice: 1.99, unitPrice: 1.79, co2: 1, packaging: "Paper", organic: false, category: "staples" },
            { id: 29, name: "Olive Oil", size: "16 oz", price: 7.99, listPrice: 8.99, unitPrice: 0.50, co2: 2, packaging: "Glass", organic: false, category: "staples" },
            { id: 30, name: "Organic Olive Oil", size: "16 oz", price: 12.99, listPrice: 13.99, unitPrice: 0.81, co2: 2, packaging: "Glass", organic: true, category: "staples" },
            { id: 31, name: "Canned Tomatoes", size: "14 oz", price: 1.49, listPrice: 1.79, unitPrice: 0.11, co2: 2, packaging: "None", organic: false, category: "staples" },
            { id: 32, name: "Organic Canned Tomatoes", size: "14 oz", price: 2.29, listPrice: 2.79, unitPrice: 0.16, co2: 2, packaging: "None", organic: true, category: "staples" },
            
            // Frozen & Convenience
            { id: 33, name: "Frozen Mixed Vegetables", size: "1 lb", price: 2.49, listPrice: 2.99, unitPrice: 2.49, co2: 1, packaging: "Plastic", organic: false, category: "frozen" },
            { id: 57, name: "Organic Frozen Mixed Vegetables", size: "1 lb", price: 3.49, listPrice: 3.99, unitPrice: 3.49, co2: 1, packaging: "Plastic", organic: true, category: "frozen" },
            { id: 34, name: "Organic Frozen Berries", size: "1 lb", price: 4.99, listPrice: 5.49, unitPrice: 4.99, co2: 1, packaging: "Plastic", organic: true, category: "frozen" },
            { id: 58, name: "Frozen Berries", size: "1 lb", price: 3.99, listPrice: 4.49, unitPrice: 3.99, co2: 1, packaging: "Plastic", organic: false, category: "frozen" },
            { id: 35, name: "Frozen Pizza (Personal)", size: "Single", price: 3.99, listPrice: 4.49, unitPrice: 3.99, co2: 3, packaging: "Plastic", organic: false, category: "frozen" },
            { id: 37, name: "Ice Cream", size: "Pint", price: 4.99, listPrice: 5.49, unitPrice: 4.99, co2: 4, packaging: "Paper", organic: false, category: "frozen" },
            { id: 39, name: "Frozen French Fries", size: "2 lb", price: 2.99, listPrice: 3.49, unitPrice: 1.50, co2: 2, packaging: "Plastic", organic: false, category: "frozen" },
            { id: 60, name: "Frozen Meals", size: "2 pack", price: 6.99, listPrice: 7.99, unitPrice: 3.50, co2: 2, packaging: "Paper", organic: false, category: "frozen" }
        ];

        function startStudy() {
            // Set up strategy selection based on assigned count
            setupStrategySelection();
            
            // Show strategy selection phase
            document.getElementById('phase-welcome').classList.remove('active');
            document.getElementById('phase-strategy-selection').classList.add('active');
        }

        function setupStrategySelection() {
            const assignedCount = studyData.strategyCount;
            const countElement = document.getElementById('assigned-strategy-count');
            
            countElement.textContent = assignedCount;
            
            // Update the description text based on strategy count
            const descriptionElement = document.querySelector('#phase-strategy-selection .instructions p:first-of-type');
            if (assignedCount === 1) {
                descriptionElement.innerHTML = 'Imagine you are committed to sustainability goals and need to select <strong id="assigned-strategy-count">1</strong> sustainable strategy to achieve this goal during your grocery shopping.';
            } else {
                descriptionElement.innerHTML = 'Imagine you are committed to sustainability goals and need to select <strong id="assigned-strategy-count">3</strong> sustainable strategies to achieve this goal during your grocery shopping.';
            }
            
            // Clear any previous selections
            const checkboxes = document.querySelectorAll('#strategy-options input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = false;
                checkbox.closest('.strategy-option').classList.remove('selected', 'disabled');
            });
            
            // Update validation
            validateSelection();
        }


        function validateSelection() {
            const checkedBoxes = document.querySelectorAll('#strategy-options input[type="checkbox"]:checked');
            const targetCount = studyData.strategyCount;
            const currentCount = checkedBoxes.length;
            
            // Update visual selection
            checkedBoxes.forEach(checkbox => {
                checkbox.closest('.strategy-option').classList.add('selected');
            });
            
            // Disable/enable checkboxes based on selection
            const allCheckboxes = document.querySelectorAll('#strategy-options input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                if (!checkbox.checked && currentCount >= targetCount) {
                    checkbox.disabled = true;
                    checkbox.closest('.strategy-option').classList.add('disabled');
                } else if (checkbox.checked) {
                    checkbox.disabled = false;
                    checkbox.closest('.strategy-option').classList.remove('disabled');
                }
            });
            
            // Enable/disable continue button
            const continueBtn = document.getElementById('continue-to-instructions');
            continueBtn.disabled = currentCount !== targetCount;
            
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            const checkedBoxes = document.querySelectorAll('#strategy-options input[type="checkbox"]:checked');
            const summaryDiv = document.getElementById('selection-summary');
            const strategiesList = document.getElementById('selected-strategies-list');
            
            if (checkedBoxes.length > 0) {
                const strategyNames = {
                    'organic': 'Organic Focus',
                    'local': 'Local Sourcing',
                    'minimal-packaging': 'Minimal Packaging',
                    'plant-based': 'Plant-Based Focus',
                    'seasonal': 'Seasonal Eating',
                    'bulk-buying': 'Bulk Buying'
                };
                
                const selectedStrategies = Array.from(checkedBoxes).map(checkbox => 
                    strategyNames[checkbox.value] || checkbox.value
                );
                
                strategiesList.innerHTML = selectedStrategies.map(strategy => 
                    `<div style="margin: 5px 0; padding: 5px; background: #d4edda; border-radius: 3px;">✓ ${strategy}</div>`
                ).join('');
                
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        function proceedToInstructions() {
            const checkedBoxes = document.querySelectorAll('#strategy-options input[type="checkbox"]:checked');
            const targetCount = studyData.strategyCount;
            
            if (checkedBoxes.length !== targetCount) {
                alert(`Please select exactly ${targetCount} ${targetCount === 1 ? 'strategy' : 'strategies'}.`);
                return;
            }
            
            // Store selected strategies
            studyData.selectedStrategies = Array.from(checkedBoxes).map(checkbox => checkbox.value);
            
            // Display selected strategies in instructions
            displaySelectedStrategies();
            
            // Move to instructions phase
            document.getElementById('phase-strategy-selection').classList.remove('active');
            document.getElementById('phase-instructions').classList.add('active');
        }

        function displaySelectedStrategies() {
            const strategyDiv = document.getElementById('strategy-assignment');
            const strategyNames = {
                'organic': 'Organic Focus',
                'local': 'Local Sourcing',
                'minimal-packaging': 'Minimal Packaging',
                'plant-based': 'Plant-Based Focus',
                'seasonal': 'Seasonal Eating',
                'bulk-buying': 'Bulk Buying'
            };
            
            const selectedNames = studyData.selectedStrategies.map(s => strategyNames[s] || s);
            
            strategyDiv.innerHTML = `
                <h3>🎯 Your Selected ${studyData.strategyCount === 1 ? 'Strategy' : 'Strategies'}</h3>
                <p><strong>You will follow these ${studyData.strategyCount === 1 ? 'strategy' : 'strategies'} during your shopping:</strong></p>
                <ul>
                    ${selectedNames.map(name => `<li><strong>${name}</strong></li>`).join('')}
                </ul>
                <p>Keep these ${studyData.strategyCount === 1 ? 'strategy' : 'strategies'} in mind as you make your product selections.</p>
            `;
        }

        function startShopping() {
            document.getElementById('phase-instructions').classList.remove('active');
            document.getElementById('phase-shopping').classList.add('active');
            
            studyData.shoppingStartTime = new Date();
            useAmazonPrices();
            renderProducts();
            updateCartDisplay();
        }

        function useAmazonPrices() {
            // Normalize each product's price to Amazon-referenced price (avg)
            for (let i = 0; i < products.length; i++) {
                const p = products[i];
                const hasMin = typeof p.amazonMin === 'number';
                const hasMax = typeof p.amazonMax === 'number';
                const hasAvg = typeof p.amazonAvg === 'number';
                const amazonAvg = hasAvg ? p.amazonAvg : (hasMin && hasMax ? (p.amazonMin + p.amazonMax) / 2 : p.price);
                products[i] = { ...p, price: amazonAvg };
            }
        }

        function renderProducts(category = 'all') {
            const grid = document.getElementById('products-grid');
            const filteredProducts = category === 'all' ? products : products.filter(p => p.category === category);
            
            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card" data-category="${product.category}">
                    <div class="product-name">${product.name}</div>
                    <div class="price-block">
                        <div class="product-price">$${product.price.toFixed(2)}</div>
                    </div>
                    ${product.unitPrice ? `<div class="unit-price">$${Number(product.unitPrice).toFixed(2)} per unit</div>` : ''}
                    ${product.size ? `<div class="size-note">Size: ${product.size}</div>` : ''}
                    <div class="product-attributes">
                        <span class="attribute-tag co2-${product.co2}">CO₂: ${product.co2}</span>
                        <span class="attribute-tag packaging-tag">${product.packaging}</span>
                        ${product.organic ? '<span class="attribute-tag organic-tag">Organic</span>' : ''}
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity(${product.id}, -1)">-</button>
                        <input type="number" class="quantity-input" id="qty-${product.id}" value="1" min="1" max="10" onchange="updateQuantity(${product.id})">
                        <button class="quantity-btn" onclick="changeQuantity(${product.id}, 1)">+</button>
                    </div>
                    <button class="add-btn" onclick="addToCart(${product.id})">
                        Add to Cart
                    </button>
                </div>
            `).join('');
        }

        function filterCategory(category, el) {
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            if (el) el.classList.add('active');
            
            // Show/hide products
            renderProducts(category);
        }

        function changeQuantity(productId, change) {
            const input = document.getElementById(`qty-${productId}`);
            let newValue = parseInt(input.value) + change;
            newValue = Math.max(1, Math.min(10, newValue)); // Keep between 1 and 10
            input.value = newValue;
        }

        function updateQuantity(productId) {
            const input = document.getElementById(`qty-${productId}`);
            let value = parseInt(input.value);
            value = Math.max(1, Math.min(10, value)); // Keep between 1 and 10
            input.value = value;
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const quantity = parseInt(document.getElementById(`qty-${productId}`).value) || 1;
            const totalPrice = product.price * quantity;

            // Check if adding this item would exceed budget significantly
            const currentTotal = studyData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (currentTotal + totalPrice > 55) {
                alert('Adding this item would exceed the maximum budget of $55. Please choose a less expensive item or reduce quantity.');
                return;
            }

            // Check if already in cart
            const existingItem = studyData.cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                studyData.cart.push({
                    ...product,
                    quantity: quantity,
                    addedAt: new Date()
                });
            }

            // Log action
            studyData.shoppingActions.push({
                action: 'add',
                productId: product.id,
                quantity: quantity,
                timestamp: new Date()
            });

            updateCartDisplay();
        }

        function removeFromCart(index) {
            const removedItem = studyData.cart[index];
            studyData.cart.splice(index, 1);
            
            // Log action
            studyData.shoppingActions.push({
                action: 'remove',
                productId: removedItem.id,
                quantity: removedItem.quantity,
                timestamp: new Date()
            });

            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartTotal = studyData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const cartCO2 = studyData.cart.reduce((sum, item) => sum + (item.co2 * item.quantity), 0);
            const itemCount = studyData.cart.reduce((sum, item) => sum + item.quantity, 0);
            const budgetRemaining = 50 - cartTotal;

            // Update stats
            document.getElementById('cart-total').textContent = `$${cartTotal.toFixed(2)}`;
            document.getElementById('cart-items').textContent = itemCount;
            document.getElementById('cart-co2').textContent = cartCO2;
            document.getElementById('budget-remaining').textContent = `$${budgetRemaining.toFixed(2)}`;

            // Update progress bar (showing budget usage)
            const progressBar = document.getElementById('budget-progress');
            const progressPercent = Math.min((cartTotal / 50) * 100, 100);
            progressBar.style.width = `${progressPercent}%`;

            // Update cart items list
            const cartItemsList = document.getElementById('cart-items-list');
            if (studyData.cart.length === 0) {
                cartItemsList.innerHTML = '<p style="text-align: center; color: #6c757d; font-style: italic;">Your cart is empty</p>';
            } else {
                cartItemsList.innerHTML = studyData.cart.map((item, index) => `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">${item.name} ${item.quantity > 1 ? `(×${item.quantity})` : ''}</div>
                            <div style="font-size: 12px; color: #6c757d;">$${(item.price * item.quantity).toFixed(2)} • CO₂: ${item.co2 * item.quantity}</div>
                        </div>
                        <button class="remove-btn" onclick="removeFromCart(${index})">Remove</button>
                    </div>
                `).join('');
            }

            // Update checkout button
            const checkoutBtn = document.getElementById('checkout-btn');
            const canCheckout = studyData.cart.length >= 1;
            checkoutBtn.disabled = !canCheckout;
            
            if (canCheckout) {
                checkoutBtn.innerHTML = 'Complete Shopping<div style="font-size: 12px; margin-top: 5px;">Ready to checkout!</div>';
            } else {
                checkoutBtn.innerHTML = 'Complete Shopping<div style="font-size: 12px; margin-top: 5px;">Add at least 1 item to checkout</div>';
            }
        }

        function checkout() {
            const cartTotal = studyData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = studyData.cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // Record completion time
            studyData.shoppingEndTime = new Date();
            studyData.shoppingDuration = (studyData.shoppingEndTime - studyData.shoppingStartTime) / 1000; // seconds

            // Record final cart decisions with detailed product information
            studyData.finalCartDecisions = studyData.cart.map(item => ({
                productId: item.id,
                productName: item.name,
                category: item.category,
                price: item.price,
                quantity: item.quantity,
                totalPrice: item.price * item.quantity,
                co2Rating: item.co2,
                totalCO2: item.co2 * item.quantity,
                packaging: item.packaging,
                organic: item.organic,
                size: item.size,
                unitPrice: item.unitPrice,
                addedAt: item.addedAt
            }));

            // Calculate final metrics
            const finalCO2 = studyData.cart.reduce((sum, item) => sum + (item.co2 * item.quantity), 0);
            const organicCount = studyData.cart.reduce((sum, item) => sum + (item.organic ? item.quantity : 0), 0);
            const plasticCount = studyData.cart.reduce((sum, item) => sum + (item.packaging === 'Plastic' ? item.quantity : 0), 0);

            // Show completion phase
            document.getElementById('phase-shopping').classList.remove('active');
            document.getElementById('phase-complete').classList.add('active');

            // Display final summary
            document.getElementById('final-summary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0;">
                    <div><strong>Total Items:</strong> ${itemCount}</div>
                    <div><strong>Total Cost:</strong> $${cartTotal.toFixed(2)}</div>
                    <div><strong>Total CO₂ Points:</strong> ${finalCO2}</div>
                    <div><strong>Organic Items:</strong> ${organicCount}</div>
                    <div><strong>Plastic Packages:</strong> ${plasticCount}</div>
                    <div><strong>Shopping Time:</strong> ${Math.round(studyData.shoppingDuration)} seconds</div>
                </div>
            `;
        }

        function nextToDemographics() {
            // Collect post-study responses
            const confidence = document.querySelector('input[name="confidence"]:checked');
            const difficulty = document.querySelector('input[name="difficulty"]:checked');

            if (!confidence) {
                alert('Please answer the confidence question before continuing.');
                return;
            }

            if (!difficulty) {
                alert('Please answer the difficulty question before continuing.');
                return;
            }

            // Store post-study data
            studyData.postStudy = {
                confidence: parseInt(confidence.value),
                difficulty: parseInt(difficulty.value),
                completedAt: new Date()
            };

            // Move to demographics phase
            document.getElementById('phase-complete').style.display = 'none';
            document.getElementById('phase-demographics').style.display = 'block';
        }

        function submitStudy() {
            // Collect demographics
            const age = document.getElementById('age').value;
            const gender = document.querySelector('input[name="gender"]:checked');
            const demographicsComments = document.getElementById('demographics-comments').value;

            if (!age) {
                alert('Please provide your age before submitting.');
                return;
            }

            if (!gender) {
                alert('Please select your gender before submitting.');
                return;
            }

            studyData.demographics = {
                age: parseInt(age),
                gender: gender.value,
                additionalComments: demographicsComments
            };

            // Calculate final metrics for analysis
            const finalMetrics = {
                totalCO2: studyData.cart.reduce((sum, item) => sum + (item.co2 * item.quantity), 0),
                totalCost: studyData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                itemCount: studyData.cart.reduce((sum, item) => sum + item.quantity, 0),
                organicCount: studyData.cart.reduce((sum, item) => sum + (item.organic ? item.quantity : 0), 0),
                plasticCount: studyData.cart.reduce((sum, item) => sum + (item.packaging === 'Plastic' ? item.quantity : 0), 0),
                averageCO2: studyData.cart.length ? (studyData.cart.reduce((sum, item) => sum + (item.co2 * item.quantity), 0) / studyData.cart.reduce((sum, item) => sum + item.quantity, 0)) : 0,
                shoppingDuration: studyData.shoppingDuration
            };

            studyData.finalMetrics = finalMetrics;

            // Send data to server (if available) or save locally
            saveStudyData(studyData);
            
            // Display thank you message
            document.getElementById('phase-demographics').innerHTML = `
                <div class="instructions">
                    <div class="alert alert-success">
                        <h2>Thank You! 🎉</h2>
                        <p><strong>Your participation is complete!</strong></p>
                        <p>Participant ID: <strong>${studyData.participantId}</strong></p>
                        <p>Your responses have been recorded. Thank you for contributing to our research on sustainable shopping behavior.</p>
                        <br>
                        <p><em>Your data has been automatically saved for research analysis.</em></p>
                    </div>
                </div>
            `;
        }

        function saveStudyData(data) {
            // Always try to send to server first
            fetch('/api/save-study-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    console.log('Data successfully sent to server');
                } else {
                    throw new Error('Server error');
                }
            }).catch(() => {
                // If server unavailable, save to localStorage as backup
                const existingData = JSON.parse(localStorage.getItem('studyData') || '[]');
                existingData.push(data);
                localStorage.setItem('studyData', JSON.stringify(existingData));
                console.log('Data saved locally as backup:', data);
            });
        }

        function downloadData() {
            const dataStr = JSON.stringify(studyData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `shopping-study-${studyData.participantId}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Make sure all functions are available globally
        window.startStudy = startStudy;
        window.startShopping = startShopping;
        window.filterCategory = filterCategory;
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.checkout = checkout;
        window.submitStudy = submitStudy;
    </script>
</body>
</html>

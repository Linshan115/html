<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher Data Access</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .data-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .password-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”¬ Researcher Data Access</h1>
            <p>Study Data Collection Dashboard</p>
        </div>

        <div id="password-section" class="password-section">
            <h3>Access Control</h3>
            <p>Enter researcher password to access data:</p>
            <input type="password" id="password-input" placeholder="Enter password">
            <button class="btn" onclick="checkPassword()">Access Data</button>
        </div>

        <div id="data-dashboard" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-participants">0</div>
                    <div class="stat-label">Total Participants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-cost">$0</div>
                    <div class="stat-label">Average Cart Cost</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-co2">0</div>
                    <div class="stat-label">Average COâ‚‚ Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completion-rate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            </div>

            <div class="data-section">
                <h3>Data Export</h3>
                <button class="btn btn-success" onclick="exportCSV()">Download CSV</button>
                <button class="btn" onclick="exportJSON()">Download JSON</button>
                <button class="btn" onclick="clearData()">Clear All Data</button>
            </div>

            <div class="data-section">
                <h3>Participant Data</h3>
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Participant ID</th>
                            <th>Condition</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>IP Address</th>
                            <th>Total Cost</th>
                            <th>COâ‚‚ Score</th>
                            <th>Items</th>
                            <th>Duration (min)</th>
                            <th>Completed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="data-tbody">
                    </tbody>
                </table>
            </div>

            <div class="data-section">
                <h3>Final Cart Decisions</h3>
                <div id="cart-details">
                    <p>Select a participant above to view their final cart decisions.</p>
                </div>
            </div>

            <div class="data-section">
                <h3>Click Data & Shopping Actions</h3>
                <div id="click-details">
                    <p>Select a participant above to view their complete shopping behavior.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const RESEARCHER_PASSWORD = 'sustainability2024'; // Change this password
        let studyData = [];

        function checkPassword() {
            const password = document.getElementById('password-input').value;
            if (password === RESEARCHER_PASSWORD) {
                document.getElementById('password-section').classList.add('hidden');
                document.getElementById('data-dashboard').classList.remove('hidden');
                loadData();
            } else {
                alert('Incorrect password');
            }
        }

        function loadData() {
            // Try to load from server first
            fetch('/api/study-data')
                .then(response => response.json())
                .then(data => {
                    studyData = data;
                    updateDashboard();
                })
                .catch(() => {
                    // Fallback to localStorage
                    const localData = JSON.parse(localStorage.getItem('studyData') || '[]');
                    studyData = localData;
                    updateDashboard();
                });
        }

        function updateDashboard() {
            if (studyData.length === 0) {
                document.getElementById('total-participants').textContent = '0';
                return;
            }

            const completed = studyData.filter(p => p.finalMetrics);
            const avgCost = completed.reduce((sum, p) => sum + (p.finalMetrics?.totalCost || 0), 0) / completed.length;
            const avgCO2 = completed.reduce((sum, p) => sum + (p.finalMetrics?.totalCO2 || 0), 0) / completed.length;
            const completionRate = (completed.length / studyData.length) * 100;

            document.getElementById('total-participants').textContent = studyData.length;
            document.getElementById('avg-cost').textContent = `$${avgCost.toFixed(2)}`;
            document.getElementById('avg-co2').textContent = avgCO2.toFixed(1);
            document.getElementById('completion-rate').textContent = `${completionRate.toFixed(1)}%`;

            // Update table
            const tbody = document.getElementById('data-tbody');
            tbody.innerHTML = studyData.map((participant, index) => `
                <tr>
                    <td>${participant.participantId}</td>
                    <td>${participant.condition}</td>
                    <td>${participant.demographics?.age || 'N/A'}</td>
                    <td>${participant.demographics?.gender || 'N/A'}</td>
                    <td>${participant.ipAddress || 'N/A'}</td>
                    <td>$${participant.finalMetrics?.totalCost?.toFixed(2) || 'N/A'}</td>
                    <td>${participant.finalMetrics?.totalCO2 || 'N/A'}</td>
                    <td>${participant.finalMetrics?.itemCount || 'N/A'}</td>
                    <td>${participant.finalMetrics?.shoppingDuration ? Math.round(participant.finalMetrics.shoppingDuration / 60) : 'N/A'}</td>
                    <td>${participant.finalMetrics ? 'Yes' : 'No'}</td>
                    <td><button class="btn" onclick="viewCartDecisions(${index})">View Cart</button></td>
                </tr>
            `).join('');
        }

        function exportCSV() {
            if (studyData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = [
                'participantId', 'condition', 'strategyCount', 'selectedStrategies', 'age', 'gender', 'ipAddress', 'totalCost', 'totalCO2', 'itemCount',
                'organicCount', 'plasticCount', 'averageCO2', 'shoppingDuration',
                'totalActions', 'addActions', 'removeActions', 'netItems',
                'confidence', 'difficulty', 'demographicsComments', 'completedAt'
            ];
            
            const rows = studyData.map(participant => {
                const actions = participant.shoppingActions || [];
                const addActions = actions.filter(a => a.action === 'add').length;
                const removeActions = actions.filter(a => a.action === 'remove').length;
                
                return [
                    participant.participantId,
                    participant.condition,
                    participant.strategyCount || '',
                    participant.selectedStrategies ? participant.selectedStrategies.join(';') : '',
                    participant.demographics?.age || '',
                    participant.demographics?.gender || '',
                    participant.ipAddress || '',
                    participant.finalMetrics?.totalCost || 0,
                    participant.finalMetrics?.totalCO2 || 0,
                    participant.finalMetrics?.itemCount || 0,
                    participant.finalMetrics?.organicCount || 0,
                    participant.finalMetrics?.plasticCount || 0,
                    participant.finalMetrics?.averageCO2 || 0,
                    participant.finalMetrics?.shoppingDuration || 0,
                    actions.length,
                    addActions,
                    removeActions,
                    addActions - removeActions,
                    participant.postStudy?.confidence || '',
                    participant.postStudy?.difficulty || '',
                    participant.demographics?.additionalComments || '',
                    participant.postStudy?.completedAt || ''
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            downloadFile(csv, 'study-data.csv', 'text/csv');
        }

        function exportJSON() {
            if (studyData.length === 0) {
                alert('No data to export');
                return;
            }
            downloadFile(JSON.stringify(studyData, null, 2), 'study-data.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                studyData = [];
                localStorage.removeItem('studyData');
                updateDashboard();
                alert('All data cleared');
            }
        }

        function viewCartDecisions(participantIndex) {
            const participant = studyData[participantIndex];
            const cartDecisions = participant.finalCartDecisions || [];
            const shoppingActions = participant.shoppingActions || [];
            
            if (cartDecisions.length === 0) {
                document.getElementById('cart-details').innerHTML = `
                    <p><strong>${participant.participantId}</strong> - No cart decisions recorded (study not completed)</p>
                `;
                document.getElementById('click-details').innerHTML = `
                    <p><strong>${participant.participantId}</strong> - No shopping actions recorded (study not completed)</p>
                `;
                return;
            }
            
            // Display final cart decisions
            const cartHTML = `
                <h4>${participant.participantId} - Final Cart Decisions (${cartDecisions.length} items)</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>COâ‚‚</th>
                            <th>Packaging</th>
                            <th>Organic</th>
                            <th>Size</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cartDecisions.map(item => `
                            <tr>
                                <td>${item.productName}</td>
                                <td>${item.category}</td>
                                <td>$${item.price.toFixed(2)}</td>
                                <td>${item.co2Rating}</td>
                                <td>${item.packaging}</td>
                                <td>${item.organic ? 'Yes' : 'No'}</td>
                                <td>${item.size}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
                    <strong>Summary:</strong> Total Cost: $${participant.finalMetrics?.totalCost?.toFixed(2) || 'N/A'} | 
                    Total COâ‚‚: ${participant.finalMetrics?.totalCO2 || 'N/A'} | 
                    Organic Items: ${participant.finalMetrics?.organicCount || 0} | 
                    Plastic Packages: ${participant.finalMetrics?.plasticCount || 0}
                </div>
            `;
            
            // Display click data and shopping actions
            const clickHTML = `
                <h4>${participant.participantId} - Complete Shopping Behavior (${shoppingActions.length} actions)</h4>
                <div style="margin-bottom: 15px;">
                    <strong>Shopping Duration:</strong> ${participant.finalMetrics?.shoppingDuration ? Math.round(participant.finalMetrics.shoppingDuration / 60) + ' minutes' : 'N/A'} | 
                    <strong>Strategy:</strong> ${participant.condition === 'single' ? 'Climate Focus' : 'Balanced Ethical'} | 
                    <strong>Total Actions:</strong> ${shoppingActions.length}
                </div>
                <table style="width: 100%; margin-top: 15px; font-size: 12px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th>Action</th>
                            <th>Product ID</th>
                            <th>Timestamp</th>
                            <th>Time from Start</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${shoppingActions.map((action, index) => {
                            const timeFromStart = action.timestamp ? 
                                Math.round((new Date(action.timestamp) - new Date(participant.startTime)) / 1000) + 's' : 
                                'N/A';
                            return `
                                <tr style="background: ${action.action === 'add' ? '#d4edda' : '#f8d7da'};">
                                    <td>${action.action === 'add' ? 'âž• Added' : 'âž– Removed'}</td>
                                    <td>${action.productId}</td>
                                    <td>${action.timestamp ? new Date(action.timestamp).toLocaleTimeString() : 'N/A'}</td>
                                    <td>${timeFromStart}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
                    <strong>Behavior Analysis:</strong> 
                    Add Actions: ${shoppingActions.filter(a => a.action === 'add').length} | 
                    Remove Actions: ${shoppingActions.filter(a => a.action === 'remove').length} | 
                    Net Items: ${shoppingActions.filter(a => a.action === 'add').length - shoppingActions.filter(a => a.action === 'remove').length}
                </div>
            `;
            
            document.getElementById('cart-details').innerHTML = cartHTML;
            document.getElementById('click-details').innerHTML = clickHTML;
        }

        // Allow Enter key for password
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
    </script>
</body>
</html>
